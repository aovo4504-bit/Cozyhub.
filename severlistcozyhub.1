--========================================================--
--           COZYHUB KEY SYSTEM - FIXED VERSION           --
--   Check key qua Firebase + IP + HWID + Expire + used   --
--      UI gi·ªëng h√¨nh CozyHub Key b·∫°n ƒë√£ g·ª≠i             --
--========================================================--

local Http       = game:GetService("HttpService")
local Players    = game:GetService("Players")
local Analytics  = game:GetService("RbxAnalyticsService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui   = LocalPlayer:WaitForChild("PlayerGui")

--=================== CONFIG ===================--

local FIREBASE    = "https://cozyhubkey-default-rtdb.asia-southeast1.firebasedatabase.app"
local GET_KEY_URL = "https://aovo4504-bit.github.io/CozyHub.key/"  -- web get key c·ªßa b·∫°n

--=================== KEY FUNCTIONS =============--

local function getIP()
    local ok, res = pcall(function()
        return Http:GetAsync("https://api.ipify.org?format=json")
    end)
    if not ok then return nil, "Cannot get IP" end

    local data
    local suc = pcall(function() data = Http:JSONDecode(res) end)
    if not suc or not data or not data.ip then
        return nil, "Invalid IP response"
    end
    return data.ip:gsub("%.", "_")
end

local function getHWID()
    return Analytics:GetClientId()
end

local function getKeyData(key)
    local ok, res = pcall(function()
        return Http:GetAsync(FIREBASE .. "/keys/" .. key .. ".json")
    end)
    if not ok then return nil, "Server error" end

    local data
    local suc = pcall(function() data = Http:JSONDecode(res) end)
    if not suc then return nil, "Invalid key data" end

    return data
end

local function patchKey(key, tbl)
    pcall(function()
        Http:RequestAsync({
            Url = FIREBASE .. "/keys/" .. key .. ".json",
            Method = "PATCH",
            Headers = { ["Content-Type"] = "application/json" },
            Body = Http:JSONEncode(tbl)
        })
    end)
end

local function validateKey(key)
    local data, err = getKeyData(key)
    if not data then
        return false, err or "Invalid key!"
    end

    -- 1) Expire 24h
    local now = os.time() * 1000
    local exp = tonumber(data.expire or 0)
    if exp < now then
        return false, "Key expired!"
    end

    -- 2) Used
    if data.used == true then
        return false, "Key already used!"
    end

    -- 3) IP lock
    local ip, ipErr = getIP()
    if not ip then
        return false, ipErr or "Cannot get IP"
    end
    if data.ip and data.ip ~= ip then
        return false, "Key not for this IP!"
    end

    -- 4) HWID lock (auto bind l·∫ßn ƒë·∫ßu)
    local hwid = getHWID()
    if not data.hwid then
        -- l·∫ßn ƒë·∫ßu d√πng -> g√°n hwid
        patchKey(key, { hwid = hwid })
    elseif data.hwid ~= hwid then
        return false, "Key linked to another device!"
    end

    return true, "OK"
end

local function markUsed(key)
    patchKey(key, { used = true })
end

--=================== UI T·∫†O GI·ªêNG H√åNH ===================--

local gui = Instance.new("ScreenGui")
gui.Name = "CozyHubKeyUI"
gui.ResetOnSpawn = false
gui.Parent = PlayerGui

-- MAIN FRAME
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 650, 0, 360)
frame.Position = UDim2.new(0.5, -325, 0.5, -180)
frame.BackgroundColor3 = Color3.fromRGB(8, 12, 22)
frame.BorderSizePixel = 0
frame.BackgroundTransparency = 0.05
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 45)

-- GLow (d√πng image c√≥ glow s·∫µn, n·∫øu kh√¥ng c√≥ th√¨ b·ªè ph·∫ßn n√†y c≈©ng ƒë∆∞·ª£c)
local glow = Instance.new("ImageLabel", frame)
glow.Size = UDim2.new(1, 120, 1, 120)
glow.Position = UDim2.new(0.5, -385, 0.5, -220)
glow.Image = "rbxassetid://5028857084" -- generic glow sprite
glow.ImageColor3 = Color3.fromRGB(0, 255, 255)
glow.ImageTransparency = 0.55
glow.ZIndex = -1
glow.BackgroundTransparency = 1

-- TITLE
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 70)
title.Position = UDim2.new(0, 0, 0, 15)
title.BackgroundTransparency = 1
title.Text = "CozyHub Key"
title.TextColor3 = Color3.fromRGB(0, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 46

-- INPUT OUTLINE BOX
local inputHolder = Instance.new("Frame", frame)
inputHolder.Size = UDim2.new(0, 410, 0, 60)
inputHolder.Position = UDim2.new(0.05, 0, 0.30, 0)
inputHolder.BackgroundColor3 = Color3.fromRGB(8, 12, 22)
inputHolder.BorderSizePixel = 0
Instance.new("UICorner", inputHolder).CornerRadius = UDim.new(0, 35)

local inputStroke = Instance.new("UIStroke", inputHolder)
inputStroke.Color = Color3.fromRGB(0,255,255)
inputStroke.Thickness = 2
inputStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

local keyBox = Instance.new("TextBox", inputHolder)
keyBox.Size = UDim2.new(1, -40, 1, -20)
keyBox.Position = UDim2.new(0, 20, 0, 10)
keyBox.BackgroundTransparency = 1
keyBox.PlaceholderText = "Enter your key..."
keyBox.PlaceholderColor3 = Color3.fromRGB(100, 150, 170)
keyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
keyBox.Font = Enum.Font.Gotham
keyBox.TextSize = 22
keyBox.ClearTextOnFocus = false
keyBox.TextXAlignment = Enum.TextXAlignment.Left

-- VERIFY BUTTON
local verifyBtn = Instance.new("TextButton", frame)
verifyBtn.Size = UDim2.new(0, 180, 0, 60)
verifyBtn.Position = UDim2.new(0.70, 0, 0.30, 0)
verifyBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 230)
verifyBtn.BorderSizePixel = 0
verifyBtn.Text = "VERIFY KEY"
verifyBtn.TextColor3 = Color3.fromRGB(0,0,0)
verifyBtn.Font = Enum.Font.GothamBold
verifyBtn.TextSize = 24
Instance.new("UICorner", verifyBtn).CornerRadius = UDim.new(0, 35)

-- GET KEY BUTTON
local getBtn = Instance.new("TextButton", frame)
getBtn.Size = UDim2.new(0.90, 0, 0, 70)
getBtn.Position = UDim2.new(0.05, 0, 0.50, 0)
getBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 230)
getBtn.BorderSizePixel = 0
getBtn.Text = "GET KEY"
getBtn.TextColor3 = Color3.fromRGB(0,0,0)
getBtn.Font = Enum.Font.GothamBold
getBtn.TextSize = 28
Instance.new("UICorner", getBtn).CornerRadius = UDim.new(0, 40)

-- MESSAGE BOX
local msg = Instance.new("TextLabel", frame)
msg.Size = UDim2.new(0.90, 0, 0, 70)
msg.Position = UDim2.new(0.05, 0, 0.72, 0)
msg.BackgroundColor3 = Color3.fromRGB(110, 20, 20)
msg.BorderSizePixel = 0
msg.Text = ""
msg.TextColor3 = Color3.fromRGB(255,130,90)
msg.Font = Enum.Font.GothamBold
msg.TextSize = 28
msg.Visible = false
Instance.new("UICorner", msg).CornerRadius = UDim.new(0, 40)

--================= N∆†I B·∫†N T·ª∞ G·∫ÆN SCRIPT CH√çNH =================--

local function onKeyValid()
    -- üî• CH·ªñ N√ÄY B·∫†N T·ª∞ THAY
    -- v√≠ d·ª•: loadstring(game:HttpGet("LINK_SCRIPT_C·ª¶A_B·∫†N"))()
end

--================= BUTTON LOGIC ===================--

local verifying = false

verifyBtn.MouseButton1Click:Connect(function()
    if verifying then return end
    verifying = true

    local key = (keyBox.Text or ""):gsub("^%s+", ""):gsub("%s+$", "")

    if key == "" then
        msg.Text = "Please enter a key!"
        msg.TextColor3 = Color3.fromRGB(255,130,90)
        msg.BackgroundColor3 = Color3.fromRGB(110,20,20)
        msg.Visible = true
        verifying = false
        return
    end

    msg.Text = "Checking key..."
    msg.TextColor3 = Color3.fromRGB(255,255,255)
    msg.BackgroundColor3 = Color3.fromRGB(40,40,70)
    msg.Visible = true

    local ok, reason = validateKey(key)

    if ok then
        msg.Text = "Key valid!"
        msg.TextColor3 = Color3.fromRGB(70,255,70)
        msg.BackgroundColor3 = Color3.fromRGB(0,60,0)
        msg.Visible = true

        markUsed(key)
        task.wait(0.4)

        onKeyValid()   -- üî• ·ªü ƒë√¢y n√≥ g·ªçi h√†m c·ªßa b·∫°n
    else
        msg.Text = reason or "Invalid key!"
        msg.TextColor3 = Color3.fromRGB(255,130,90)
        msg.BackgroundColor3 = Color3.fromRGB(110,20,20)
        msg.Visible = true
    end

    verifying = false
end)

getBtn.MouseButton1Click:Connect(function()
    setclipboard(GET_KEY_URL)
    msg.Text = "Get-key link copied!"
    msg.TextColor3 = Color3.fromRGB(70,255,70)
    msg.BackgroundColor3 = Color3.fromRGB(0,60,0)
    msg.Visible = true
end)
